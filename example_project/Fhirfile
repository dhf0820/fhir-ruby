# vim:ft=ruby

::FHIR_PATH = File.expand_path(File.dirname(__FILE__))
require FHIR_PATH + '/gen/node_functions.rb'
require FHIR_PATH + '/gen/selection_functions.rb'



configure do |cfg|
  cfg.fhir_xml = FHIR_PATH + '/../spec/tmp/cache.xml'
  cfg.datatypes_xsd = FHIR_PATH + '/../fhir-base.xsd'
  cfg.node_modules = [Tableize]
  cfg.selection_modules = [SelectionQueries]
end

class ExpandGraph
  def initialize(graph)
    @graph = graph
  end

  def expand
    @graph.selection.by_attr(:embed, true).each do |node|
      res = node.referenced_resource
      res.descendants.each do |dsc|
        path = node.path.to_a + dsc.path.to_a[1..-1]
        @graph.add(path, dsc.attributes) unless @graph.path_exists?(path)
      end
    end
  end
end

generate do |graph|
  models_folder = File.dirname(__FILE__)+ '/models/fhir'
  migrations_folder = File.dirname(__FILE__)+ '/migrations'
  FileUtils.rm_rf(models_folder)
  FileUtils.rm_rf(migrations_folder)
  FileUtils.mkdir_p(migrations_folder)

  graph.rule(%w[MedicationStatement dosage site coding],  max: '1')
  graph.rule(%w[MedicationStatement dosage route coding], max: '1')
  graph.rule(%w[MedicationStatement dosage method coding], max: '1')
  graph.rule(%w[MedicationStatement identifier], max: '1')
  graph.rule(%w[MedicationStatement reasonNotGiven coding], max: '1')
  graph.rule(%w[MedicationStatement medication], max: '1', embed: true)

  ExpandGraph.new(graph).expand


  branch = graph.selection.branch(['MedicationStatement'])
  .reject { |node| %w[contained extension].include?(node.name) }

  File.open(File.join(migrations_folder, 'schema.rb'), 'w') do |f|
    f.write  %Q[execute "drop schema fhir cascade; create schema fhir;"\n]
    f.write  branch.tables
    .template(path: "#{FHIR_PATH}/templates/migration.rb.erb")
    .render(0)
  end

  branch
  .models
  .template(path: "#{FHIR_PATH}/templates/model.rb.erb")
  .file(models_folder) {|n| "#{n.class_file_name}.rb" }
end
